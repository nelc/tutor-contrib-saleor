{% if RUN_SALEOR_DASHBOARD %}
saleor-dashboard:
  image: {{ SALEOR_DASHBOARD_IMAGE }}
  environment:
    API_URL: "{% if ENABLE_HTTPS %}https{% else %}http{% endif %}://{{ SALEOR_CORE_HOST }}:{{ SALEOR_CORE_PORT }}/graphql/"
    APP_MOUNT_URI: "/dashboard/"
  ports:
    - "{{ SALEOR_DASHBOARD_PORT }}:80"
  stdin_open: true
  tty: true
  restart: unless-stopped
{% endif %}

{% if RUN_SALEOR_STOREFRONT %}
saleor-storefront:
  extra_hosts:
    - "{{ SALEOR_CORE_HOST }}:host-gateway"
  image: {{ SALEOR_STOREFRONT_IMAGE }}
  ports:
    - "{{ SALEOR_STOREFRONT_PORT }}:3000"
  command: ["npm", "start"]
  stdin_open: true
  tty: true
  restart: unless-stopped
  environment:
    API_URL: "{% if ENABLE_HTTPS %}https{% else %}http{% endif %}://{{ SALEOR_CORE_HOST }}:{{ SALEOR_CORE_PORT }}/graphql"
    SALEOR_STOREFRONT_HOST: "{{ SALEOR_STOREFRONT_HOST }}"
    LMS_ROOT_URL: "{% if ENABLE_HTTPS %}https{% else %}http{% endif %}://{{ LMS_HOST }}:8000"
{% endif %}

{% if RUN_SALEOR_CORE %}
saleor-core:
  image: {{ SALEOR_CORE_DOCKER_IMAGE }}
  ports:
  - {{ SALEOR_CORE_PORT }}:8000
  restart: unless-stopped
  stdin_open: true
  tty: true
  depends_on:
  - saleor-db
  - redis
  environment:
    DASHBOARD_URL: {{ SALEOR_DASHBOARD_HOST }}
    ALLOWED_HOSTS: localhost,api,{{ SALEOR_CORE_HOST }}, saleor-core
    DEFAULT_CHANNEL_SLUG: default-channel
    HTTP_IP_FILTER_ALLOW_LOOPBACK_IPS: "True"
    HTTP_IP_FILTER_ENABLED: "False"
    CELERY_BROKER_URL: redis://{{ REDIS_HOST }}:{{ REDIS_PORT }}/{{ SALEOR_REDIS_DB }}
    DATABASE_URL: postgres://{{ SALEOR_DB_USER }}:{{ SALEOR_DB_PASSWORD  }}@{{ SALEOR_DB_URL }}/saleor
    DEFAULT_FROM_EMAIL: noreply@example.com
    EMAIL_URL: smtp://mailpit:1025
    SECRET_KEY: changeme
    PUBLIC_URL: {% if ENABLE_HTTPS %}https{% else %}http{% endif %}://{{ SALEOR_CORE_HOST }}:{{ SALEOR_CORE_PORT }}
    RSA_PRIVATE_KEY: |-
      {{ JWT_RSA_PRIVATE_KEY | indent(6) }}
  volumes:
    - ./../../data/saleor/media:/app/media

saleor-worker:
  image: {{ SALEOR_CORE_DOCKER_IMAGE }}
  command: celery -A saleor --app=saleor.celeryconf:app worker --loglevel=info -B
  restart: unless-stopped
  stdin_open: true
  tty: true
  depends_on:
  - saleor-db
  - redis
  environment:
  - DASHBOARD_URL={{ SALEOR_DASHBOARD_HOST }}
  - ALLOWED_HOSTS=localhost,api,{{ SALEOR_CORE_HOST }}
  - DEFAULT_CHANNEL_SLUG=default-channel
  - HTTP_IP_FILTER_ALLOW_LOOPBACK_IPS=True
  - HTTP_IP_FILTER_ENABLED=False
  - CELERY_BROKER_URL=redis://{{ REDIS_HOST }}:{{ REDIS_PORT }}/{{ SALEOR_REDIS_DB }}
  - DATABASE_URL=postgres://{{ SALEOR_DB_USER }}:{{ SALEOR_DB_PASSWORD  }}@saleor-db/saleor
  - DEFAULT_FROM_EMAIL=noreply@example.com
  - EMAIL_URL=smtp://mailpit:1025
  - SECRET_KEY=changeme
  - PUBLIC_URL={% if ENABLE_HTTPS %}https{% else %}http{% endif %}://{{ SALEOR_CORE_HOST }}:{{ SALEOR_CORE_PORT }}
  volumes:
    - ./../../data/saleor/media:/app/media

saleor-db:
  image: {{ SALEOR_DB_DOCKER_IMAGE }}
  ports:
    - {{ SALEOR_DB_PORT }}:5432
  restart: unless-stopped
  volumes:
    - ./../../data/saleor/postgresql:/var/lib/postgresql/data
      - ./../../data/saleor/postgresql_replica/replica_user.sql:/docker-entrypoint-initdb.d/replica_user.sql
  environment:
    - POSTGRES_USER={{ SALEOR_DB_USER }}
    - POSTGRES_PASSWORD={{ SALEOR_DB_PASSWORD }}
{% endif %}
